name: nix build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Run go test
        run: go test -v ./...

  build_check:
    needs: test
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - run: nix build . --print-build-logs
      - run: nix flake check

      - name: Build Output
        run: ./result/bin/gonix --version

  build_release:
    needs: build_check
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch

      - name: Build
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - run: nix build .#dockerImage --impure  # access env var: APP_VERSION
        env:
          APP_VERSION: ${{ steps.tag_version.outputs.new_tag || github.sha }}
      - run: nix flake check

      - name: Build Output
        run: |
          docker load < ./result
          docker run --rm registry.fly.io/gonix-deploy:${{ steps.tag_version.outputs.new_tag }} /bin/gonix --version

      - name: Prepare Artifact
        run: cp -L ./result ./gonix-${{ steps.tag_version.outputs.new_tag }}-x86_64-linux.tar.gz

      - name: Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          files: ./gonix-${{ steps.tag_version.outputs.new_tag }}-x86_64-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.PAT }}
          repository: simonhayward/gonix-deploy
          event-type: deploy-event
          client-payload: '{"tag": "${{ steps.tag_version.outputs.new_tag }}"}'
